import type { AccountData } from "@cardinal/common";
import { AnchorProvider, Program } from "@project-serum/anchor";
import type { Connection } from "@solana/web3.js";

import type { STATS_PROGRAM, StatsEntryData } from "./constants";
import { STATS_ADDRESS, STATS_IDL } from "./constants";
import { findStatsEntryId } from "./pda";

export const getStatsEntry = async (
  connection: Connection,
  name: string
): Promise<AccountData<StatsEntryData>> => {
  // eslint-disable-next-line @typescript-eslint/ban-ts-comment
  // @ts-ignore
  const provider = new AnchorProvider(connection, null, {});
  const statsProgram = new Program<STATS_PROGRAM>(
    STATS_IDL,
    STATS_ADDRESS,
    provider
  );

  const [statsEntryId] = await findStatsEntryId(name);
  const parsed = await statsProgram.account.statsEntry.fetch(statsEntryId);
  return {
    parsed,
    pubkey: statsEntryId,
  };
};
