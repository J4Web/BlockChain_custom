{"version":3,"file":"transaction.js","sourceRoot":"","sources":["../../../../src/programs/rewardDistributor/transaction.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  tryGetAccount,\n  withFindOrInitAssociatedTokenAccount,\n} from \"@cardinal/common\";\nimport type { web3 } from \"@project-serum/anchor\";\nimport { BN } from \"@project-serum/anchor\";\nimport type { Wallet } from \"@saberhq/solana-contrib\";\nimport type { Connection, PublicKey, Transaction } from \"@solana/web3.js\";\n\nimport { getRewardDistributor, getRewardEntry } from \"./accounts\";\nimport { RewardDistributorKind } from \"./constants\";\nimport {\n  claimRewards,\n  closeRewardDistributor,\n  closeRewardEntry,\n  initRewardDistributor,\n  initRewardEntry,\n  updateRewardDistributor,\n  updateRewardEntry,\n} from \"./instruction\";\nimport { findRewardDistributorId, findRewardEntryId } from \"./pda\";\nimport { withRemainingAccountsForKind } from \"./utils\";\n\nexport const withInitRewardDistributor = async (\n  transaction: Transaction,\n  connection: Connection,\n  wallet: Wallet,\n  params: {\n    stakePoolId: PublicKey;\n    rewardMintId: PublicKey;\n    rewardAmount?: BN;\n    rewardDurationSeconds?: BN;\n    kind?: RewardDistributorKind;\n    maxSupply?: BN;\n    supply?: BN;\n    defaultMultiplier?: BN;\n    multiplierDecimals?: number;\n  }\n): Promise<[Transaction, web3.PublicKey]> => {\n  const [rewardDistributorId] = await findRewardDistributorId(\n    params.stakePoolId\n  );\n  const remainingAccountsForKind = await withRemainingAccountsForKind(\n    transaction,\n    connection,\n    wallet,\n    rewardDistributorId,\n    params.kind || RewardDistributorKind.Mint,\n    params.rewardMintId\n  );\n  transaction.add(\n    initRewardDistributor(connection, wallet, {\n      rewardDistributorId,\n      stakePoolId: params.stakePoolId,\n      rewardMintId: params.rewardMintId,\n      rewardAmount: params.rewardAmount || new BN(1),\n      rewardDurationSeconds: params.rewardDurationSeconds || new BN(1),\n      kind: params.kind || RewardDistributorKind.Mint,\n      remainingAccountsForKind,\n      maxSupply: params.maxSupply,\n      supply: params.supply,\n      defaultMultiplier: params.defaultMultiplier,\n      multiplierDecimals: params.multiplierDecimals,\n    })\n  );\n  return [transaction, rewardDistributorId];\n};\n\nexport const withInitRewardEntry = async (\n  transaction: Transaction,\n  connection: Connection,\n  wallet: Wallet,\n  params: {\n    stakeEntryId: PublicKey;\n    rewardDistributorId: PublicKey;\n  }\n): Promise<[Transaction, PublicKey]> => {\n  const [rewardEntryId] = await findRewardEntryId(\n    params.rewardDistributorId,\n    params.stakeEntryId\n  );\n  transaction.add(\n    initRewardEntry(connection, wallet, {\n      stakeEntryId: params.stakeEntryId,\n      rewardDistributor: params.rewardDistributorId,\n      rewardEntryId: rewardEntryId,\n    })\n  );\n  return [transaction, rewardEntryId];\n};\n\nexport const withClaimRewards = async (\n  transaction: Transaction,\n  connection: Connection,\n  wallet: Wallet,\n  params: {\n    stakePoolId: PublicKey;\n    stakeEntryId: PublicKey;\n  }\n): Promise<Transaction> => {\n  const [rewardDistributorId] = await findRewardDistributorId(\n    params.stakePoolId\n  );\n  const rewardDistributorData = await tryGetAccount(() =>\n    getRewardDistributor(connection, rewardDistributorId)\n  );\n\n  if (rewardDistributorData) {\n    const rewardMintTokenAccountId = await withFindOrInitAssociatedTokenAccount(\n      transaction,\n      connection,\n      rewardDistributorData.parsed.rewardMint,\n      wallet.publicKey,\n      wallet.publicKey\n    );\n\n    const remainingAccountsForKind = await withRemainingAccountsForKind(\n      transaction,\n      connection,\n      wallet,\n      rewardDistributorId,\n      rewardDistributorData.parsed.kind,\n      rewardDistributorData.parsed.rewardMint\n    );\n\n    const [rewardEntryId] = await findRewardEntryId(\n      rewardDistributorData.pubkey,\n      params.stakeEntryId\n    );\n    const rewardEntryData = await tryGetAccount(() =>\n      getRewardEntry(connection, rewardEntryId)\n    );\n\n    if (!rewardEntryData) {\n      transaction.add(\n        initRewardEntry(connection, wallet, {\n          stakeEntryId: params.stakeEntryId,\n          rewardDistributor: rewardDistributorData.pubkey,\n          rewardEntryId: rewardEntryId,\n        })\n      );\n    }\n\n    transaction.add(\n      await claimRewards(connection, wallet, {\n        stakePoolId: params.stakePoolId,\n        stakeEntryId: params.stakeEntryId,\n        rewardMintId: rewardDistributorData.parsed.rewardMint,\n        rewardMintTokenAccountId: rewardMintTokenAccountId,\n        remainingAccountsForKind,\n      })\n    );\n  }\n  return transaction;\n};\n\nexport const withCloseRewardDistributor = async (\n  transaction: Transaction,\n  connection: Connection,\n  wallet: Wallet,\n  params: {\n    stakePoolId: PublicKey;\n  }\n): Promise<Transaction> => {\n  const [rewardDistributorId] = await findRewardDistributorId(\n    params.stakePoolId\n  );\n  const rewardDistributorData = await tryGetAccount(() =>\n    getRewardDistributor(connection, rewardDistributorId)\n  );\n\n  if (rewardDistributorData) {\n    const remainingAccountsForKind = await withRemainingAccountsForKind(\n      transaction,\n      connection,\n      wallet,\n      rewardDistributorId,\n      rewardDistributorData.parsed.kind,\n      rewardDistributorData.parsed.rewardMint\n    );\n\n    transaction.add(\n      await closeRewardDistributor(connection, wallet, {\n        stakePoolId: params.stakePoolId,\n        rewardMintId: rewardDistributorData.parsed.rewardMint,\n        remainingAccountsForKind,\n      })\n    );\n  }\n  return transaction;\n};\n\nexport const withUpdateRewardEntry = async (\n  transaction: Transaction,\n  connection: Connection,\n  wallet: Wallet,\n  params: {\n    stakePoolId: PublicKey;\n    rewardDistributorId: PublicKey;\n    stakeEntryId: PublicKey;\n    multiplier: BN;\n  }\n): Promise<Transaction> => {\n  return transaction.add(\n    await updateRewardEntry(connection, wallet, {\n      stakePoolId: params.stakePoolId,\n      stakeEntryId: params.stakeEntryId,\n      multiplier: params.multiplier,\n    })\n  );\n};\n\nexport const withCloseRewardEntry = async (\n  transaction: Transaction,\n  connection: Connection,\n  wallet: Wallet,\n  params: {\n    stakePoolId: PublicKey;\n    stakeEntryId: PublicKey;\n  }\n): Promise<Transaction> => {\n  const [rewardDistributorId] = await findRewardDistributorId(\n    params.stakePoolId\n  );\n\n  const [rewardEntryId] = await findRewardEntryId(\n    rewardDistributorId,\n    params.stakeEntryId\n  );\n\n  return transaction.add(\n    closeRewardEntry(connection, wallet, {\n      rewardDistributorId: rewardDistributorId,\n      rewardEntryId: rewardEntryId,\n    })\n  );\n};\n\nexport const withUpdateRewardDistributor = async (\n  transaction: Transaction,\n  connection: Connection,\n  wallet: Wallet,\n  params: {\n    stakePoolId: PublicKey;\n    defaultMultiplier: BN;\n    multiplierDecimals: number;\n  }\n): Promise<Transaction> => {\n  const [rewardDistributorId] = await findRewardDistributorId(\n    params.stakePoolId\n  );\n\n  return transaction.add(\n    updateRewardDistributor(connection, wallet, {\n      rewardDistributorId: rewardDistributorId,\n      defaultMultiplier: params.defaultMultiplier,\n      multiplierDecimals: params.multiplierDecimals,\n    })\n  );\n};\n"]}